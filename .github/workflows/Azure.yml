name: Using Azure with Azure login
on:
    workflow_dispatch:
    push:
      branches:
        - main
permissions:
    id-token: write
    contents: read

jobs:
  azure-login:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Helm add repo
        run: |
          helm repo add nvkq2022 https://nvkq2022.github.io/helm-charts
          helm repo update
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ vars.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME }}

      
      - name: Create Namespace if it does not exist
        run: kubectl get namespace techshop || kubectl create namespace techshop
      - name: Secret for techshop-api
        run: |
          echo "${{ secrets.TECHSHOP_API_SECRET }}" > techshop-api-secrets.yaml
          kubectl apply -f techshop-api-secrets.yaml


      # - name: Create Firebase secret from file
      #   run: |
      #     echo "${{ secrets.FIREBASE_ADMIN_SDK }}" | sed 's/\\n/\n/g' > firebase-admin-sdk.json
      #     cat firebase-admin-sdk.json
      #     kubectl create secret generic firebase-admin-sdk \
      #       --from-file=serviceAccount.json=firebase-admin-sdk.json\
      #       -n techshop \
      #       --dry-run=client -o yaml | kubectl apply -f -

      - name: Firebase Secret for techshop-api
        run: |
          echo "${{ secrets.FIREBASE_ADMIN_SDK }}" > firebase-admin-sdk.yaml
          kubectl apply -f firebase-admin-sdk.yaml
      - name: Helm uninstall release if exists
        run: |
          # Check if the Helm release exists
          if helm list --namespace default | grep -q techshop-api-release; then
            echo "Release 'techshop-api-release' exists, uninstalling it."
            helm uninstall techshop-api-release --namespace default
          else
            echo "Release 'techshop-api-release' does not exist, skipping uninstall."
          fi

      - name: Helm install or upgrade release
        run: |
          # Install or upgrade the release
          helm upgrade --install techshop-api-release nvkq2022/techshop-api \
            --version 1.0.1 \
            --set service.type=LoadBalancer \
            --namespace default

      - name : Verify Deployment
        run: |
          kubectl get all -n techshop
          kubectl get secrets -n techshop
          helm status techshop-api-release